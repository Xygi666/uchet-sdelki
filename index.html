<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Учет сделки</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2f6feb">
<style>
body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f7f7f9;}
header { padding:16px; background:#2f6feb; color:#fff; display:flex; justify-content:space-between; align-items:center;}
header h1 { font-size:18px; margin:0;}
header button { background:rgba(255,255,255,.15);border:0;padding:8px 12px;border-radius:8px;color:#fff;}
main { padding:16px; max-width:720px; margin:0 auto;}
.card { background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:16px;}
.row{ display:flex; gap:12px; flex-wrap:wrap;}
input,select{ width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;}
button.primary{ background:#2f6feb; color:#fff; border:0; padding:12px; border-radius:10px; }
button.secondary{ background:#eef2ff; color:#2f4feb; border:0; padding:10px; border-radius:10px;}
.list{ width:100%; border-collapse:collapse;}
.list th,.list td{ padding:8px 6px; border-bottom:1px solid #eee; text-align:left;}
.right{text-align:right;}
.hidden{ display:none !important;}
.muted{color:#777; font-size:13px;}
.danger{color:#c62828; cursor:pointer;}
</style>
</head>
<body>
<header>
  <h1>Учет сделки</h1>
  <button onclick="toggleSettings()">Настройки</button>
</header>
<main>
  <section class="card">
    <div class="muted" id="monthLabel"></div>
    <strong id="monthTotal">0 ₽</strong>
  </section>
  <section class="card">
    <h3>Новая запись</h3>
    <div class="row">
      <div style="flex:1"><label>Тип продукции</label><select id="productSelect"></select></div>
      <div style="flex:1"><label>Количество</label><input id="qtyInput" type="number" min="0"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="saveEntry()">Сохранить</button>
      <button class="secondary" onclick="syncSheets()">Синхронизировать</button>
    </div>
    <div class="muted" id="lastStatus"></div>
  </section>
  <section class="card">
    <h3>Записи этого месяца</h3>
    <table class="list">
      <thead>
        <tr><th>Дата</th><th>Продукт</th><th class="right">Кол-во</th><th class="right">Цена</th><th class="right">Сумма</th><th></th></tr>
      </thead>
      <tbody id="entriesBody"></tbody>
      <tfoot><tr><th colspan="4" class="right">ИТОГО</th><th class="right" id="tableTotal">0 ₽</th><th></th></tr></tfoot>
    </table>
  </section>
  <section id="settingsCard" class="card hidden">
    <h3>Настройки</h3>
    <label>Apps Script URL</label>
    <input id="appsScriptUrl" placeholder="https://script.google.com/macros/s/XXX/exec">
    <label>ID Google Таблицы</label>
    <input id="sheetId">
    <label>Лист Production</label>
    <input id="productionSheet" value="Production">
    <h4 style="margin-top:20px;">Типы продукции</h4>
    <div class="row">
      <input id="prodName" placeholder="Название">
      <input id="prodPrice" type="number" placeholder="Цена ₽">
      <button class="primary" onclick="addProduct()">Добавить</button>
    </div>
    <table class="list" style="margin-top:10px;">
      <thead><tr><th>Название</th><th class="right">Цена</th><th></th></tr></thead>
      <tbody id="productsBody"></tbody>
    </table>
  </section>
</main>

<script>
const KEYS={products:'gs_products',entries:'gs_entries',settings:'gs_settings'};
let products=JSON.parse(localStorage.getItem(KEYS.products)||'[]');
let entries=JSON.parse(localStorage.getItem(KEYS.entries)||'[]');
let settings=JSON.parse(localStorage.getItem(KEYS.settings)||'{}');
const fmt=n=>new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(n);
const todayISO=()=>new Date().toISOString().split('T')[0];

function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function isThisMonth(date){
  const d=new Date(date), now=new Date();
  return d.getMonth()==now.getMonth() && d.getFullYear()==now.getFullYear();
}

function renderProducts(){
  const sel=document.getElementById('productSelect'); sel.innerHTML='';
  products.forEach(p=>{
    let opt=document.createElement('option');
    opt.value=p.id; opt.textContent=`${p.name} — ${fmt(p.price)}`;
    sel.appendChild(opt);
  });
  const tb=document.getElementById('productsBody'); tb.innerHTML='';
  products.forEach(p=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td class="right">${fmt(p.price)}</td>
                  <td><span class="danger" onclick="delProduct('${p.id}')">×</span></td>`;
    tb.appendChild(tr);
  });
}

function renderEntries(){
  let body=document.getElementById('entriesBody');
  body.innerHTML=''; let total=0;
  entries.filter(e=>isThisMonth(e.date)).forEach(e=>{
    total+=e.total;
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.date}</td><td>${e.name}</td><td class="right">${e.qty}</td>
                  <td class="right">${fmt(e.price)}</td><td class="right">${fmt(e.total)}</td>
                  <td><span class="danger" onclick="delEntry('${e.id}')">×</span></td>`;
    body.appendChild(tr);
  });
  document.getElementById('tableTotal').textContent=fmt(total);
  document.getElementById('monthTotal').textContent=fmt(total);
  document.getElementById('monthLabel').textContent=`${new Date().toLocaleString('ru-RU',{month:'long', year:'numeric'})}`;
}

function addProduct(){
  let name=document.getElementById('prodName').value.trim();
  let price=parseFloat(document.getElementById('prodPrice').value)||0;
  if(!name) return;
  products.push({id:crypto.randomUUID(), name, price});
  save(KEYS.products,products);
  renderProducts();
  document.getElementById('prodName').value='';
  document.getElementById('prodPrice').value='';
}

function delProduct(id){
  products=products.filter(p=>p.id!==id);
  save(KEYS.products,products);
  renderProducts();
}

function saveEntry(){
  let pid=document.getElementById('productSelect').value;
  let qty=parseFloat(document.getElementById('qtyInput').value)||0;
  if(!pid||qty<=0) return;
  let prod=products.find(p=>p.id==pid);
  let total=prod.price*qty;
  let entry={id:crypto.randomUUID(), date:todayISO(), productId:pid, name:prod.name, price:prod.price, qty, total, synced:false};
  entries.push(entry); save(KEYS.entries,entries);
  renderEntries();
  document.getElementById('qtyInput').value='';
  document.getElementById('lastStatus').textContent='Сохранено локально';
}

function delEntry(id){
  entries=entries.filter(e=>e.id!==id);
  save(KEYS.entries,entries); renderEntries();
}

function syncSheets(){
  const unsent=entries.filter(e=>!e.synced);
  if(!unsent.length) {document.getElementById('lastStatus').textContent='Нет данных для синхронизации'; return;}
  if(!settings.appsScriptUrl||!settings.sheetId){alert('Укажите настройки Google Script'); return;}
  fetch(settings.appsScriptUrl,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      type:'appendProduction',
      spreadsheetId:settings.sheetId,
      sheetName:settings.productionSheet||'Production',
      rows:unsent.map(e=>[new Date().toISOString(),e.date,e.productId,e.name,e.price,e.qty,e.total])
    })
  }).then(r=>r.json()).then(d=>{
    if(d.success){
      unsent.forEach(e=>e.synced=true);
      save(KEYS.entries,entries);
      renderEntries();
      document.getElementById('lastStatus').textContent='Синхронизировано с Google Таблицей';
    } else {
      document.getElementById('lastStatus').textContent='Ошибка синхронизации';
    }
  }).catch(()=>{
    document.getElementById('lastStatus').textContent='Нет соединения с Интернетом';
  });
}

function toggleSettings(){
  document.getElementById('settingsCard').classList.toggle('hidden');
  document.getElementById('appsScriptUrl').value=settings.appsScriptUrl||'';
  document.getElementById('sheetId').value=settings.sheetId||'';
  document.getElementById('productionSheet').value=settings.productionSheet||'Production';
}

['appsScriptUrl','sheetId','productionSheet'].forEach(id=>{
  document.getElementById(id).addEventListener('input',e=>{
    settings[e.target.id]=e.target.value; save(KEYS.settings,settings);
  });
});

renderProducts();
renderEntries();
</script>
</body>
</html>
