<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Учет сделки</title>
<style>
body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f7f7f9; color:#1c1c1c;}
header { padding:16px; background:#2f6feb; color:#fff; display:flex; justify-content:space-between; align-items:center;}
header h1 { font-size:18px; margin:0;}
header button { background:rgba(255,255,255,.15); color:#fff; border:0; padding:8px 12px; border-radius:8px;}
main { padding:16px; max-width:720px; margin:0 auto;}
.card{ background:#fff; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); margin-bottom:16px;}
.row{ display:flex; gap:12px; flex-wrap:wrap;}
label{ display:block; font-size:13px; color:#444; margin-bottom:6px;}
input,select{ width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; font-size:16px;}
button.primary{ background:#2f6feb; color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:600;}
button.secondary{ background:#eef2ff; color:#2f4feb; border:0; padding:10px 14px; border-radius:10px;}
.kpi{ font-size:14px; color:#666;}
.kpi strong{ font-size:24px; color:#111; display:block; margin-top:4px;}
.list{ width:100%; border-collapse:collapse;}
.list th,.list td{ padding:8px 6px; border-bottom:1px solid #eee; text-align:left; font-size:14px;}
.muted{ color:#777; font-size:13px;}
.right{text-align:right;}
.danger{ color:#c62828;}
.hidden{ display:none !important;}
</style>
</head>
<body>
<header>
  <h1>Учет сделки</h1>
  <button onclick="toggleSettings()">Настройки</button>
</header>
<main>
  <section class="card" id="summaryCard">
    <div class="kpi">
      Заработано в этом месяце
      <strong id="monthTotal">0 ₽</strong>
      <div class="muted" id="monthLabel"></div>
    </div>
  </section>
  <section class="card">
    <h3>Новая запись</h3>
    <div class="row">
      <div style="flex:1"><label>Тип продукции</label><select id="productSelect"></select></div>
      <div style="flex:1"><label>Количество</label><input id="qtyInput" type="number" min="0" step="1"/></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="saveEntry()">Сохранить</button>
      <button class="secondary" onclick="syncAirtable()">Синхронизировать</button>
    </div>
    <div class="muted" id="lastStatus"></div>
  </section>
  <section class="card">
    <h3>Записи текущего месяца</h3>
    <table class="list"><thead>
      <tr><th>Дата</th><th>Продукт</th><th class="right">Кол-во</th><th class="right">Цена</th><th class="right">Сумма</th><th></th></tr>
    </thead><tbody id="entriesBody"></tbody>
    <tfoot><tr><th colspan="4" class="right">Итого</th><th class="right" id="tableTotal">0 ₽</th><th></th></tr></tfoot>
    </table>
  </section>
  <section class="card hidden" id="settingsCard">
    <h3>Настройки AirTable</h3>
    <label>API Token</label><input id="airtableKey" placeholder="patXXXXXXXXXXXXXX">
    <label>Base ID</label><input id="airtableBase" placeholder="appXXXXXXXXXXXXXX">
    <label>Таблица Products</label><input id="productsTable" value="Products">
    <label>Таблица Production</label><input id="productionTable" value="Production">
    <div style="margin-top:12px;">
      <button onclick="testAirtableConnection()" class="secondary">Проверить подключение</button>
      <span id="testStatus" style="margin-left:10px; font-weight:600;"></span>
    </div>
    <h4 style="margin-top:20px;">Типы продукции</h4>
    <div class="row">
      <div style="flex:1"><input id="prodName" placeholder="Название продукции"></div>
      <div style="flex:1"><input id="prodPrice" type="number" placeholder="Цена ₽"></div>
      <div><button class="primary" onclick="addProductToAirtable()">Добавить</button></div>
    </div>
    <ul id="productsList" style="margin-top:10px; padding-left:20px; font-size:14px;"></ul>
  </section>
</main>

<script>
const KEYS={products:'ppx_products',entries:'ppx_entries',settings:'ppx_airtable_settings'};
let products=JSON.parse(localStorage.getItem(KEYS.products)||'[]');
let entries=JSON.parse(localStorage.getItem(KEYS.entries)||'[]');
let settings=JSON.parse(localStorage.getItem(KEYS.settings)||'{}');

const fmt=n=>new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(n||0);
const todayISO=()=>{let d=new Date(),z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
const isInMonth=(dateISO)=>{let d=new Date(dateISO),now=new Date();return d.getMonth()==now.getMonth()&&d.getFullYear()==now.getFullYear();}
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

function airtableURL(table){return `https://api.airtable.com/v0/${settings.airtableBase}/${encodeURIComponent(table)}`;}
function airtableHeaders(){return {Authorization: `Bearer ${settings.airtableKey}`, 'Content-Type':'application/json'};}

async function fetchProductsFromAirtable(){
  if(!settings.airtableKey||!settings.airtableBase) return;
  try {
    const res = await fetch(airtableURL(settings.productsTable||'Products'), {headers: airtableHeaders()});
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    products = data.records.map(r=>({id:r.id,name:r.fields.Name,price:r.fields.Price}));
    save(KEYS.products, products);
    renderProducts();
    renderProductsListInSettings();
  } catch(e) {
    document.getElementById('lastStatus').textContent = `Ошибка загрузки продуктов: ${e.message}`;
  }
}

async function addProductionToAirtable(entry){
  if(!settings.airtableKey||!settings.airtableBase) return;
  const body={fields:{
    Date: entry.date,
    Product:[entry.productId],
    Quantity: entry.qty,
    Price: entry.price,
    Total: entry.total
  }};
  await fetch(airtableURL(settings.productionTable||'Production'), {
    method:'POST',
    headers: airtableHeaders(),
    body: JSON.stringify(body)
  }).then(res=>{if(res.ok){entry.synced=true; save(KEYS.entries,entries);}});
}

function renderProducts(){
  const sel=document.getElementById('productSelect');
  sel.innerHTML='';
  products.forEach(p=>{
    let o=document.createElement('option');
    o.value=p.id;
    o.textContent=`${p.name} — ${fmt(p.price)}`;
    sel.appendChild(o);
  });
}

function renderProductsListInSettings(){
  const listEl=document.getElementById('productsList');
  listEl.innerHTML='';
  products.forEach(p=>{
    const li=document.createElement('li');
    li.textContent=`${p.name} — ${fmt(p.price)}`;
    listEl.appendChild(li);
  });
}

function renderEntries(){
  let body=document.getElementById('entriesBody');body.innerHTML='';
  let total=0;
  entries.filter(e=>isInMonth(e.date)).forEach(e=>{
    total+=e.total;
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.date}</td><td>${e.name}</td><td class="right">${e.qty}</td><td class="right">${fmt(e.price)}</td><td class="right">${fmt(e.total)}</td><td><button class="danger" onclick="delEntry('${e.id}')">×</button></td>`;
    body.appendChild(tr);
  });
  document.getElementById('tableTotal').textContent=fmt(total);
  document.getElementById('monthTotal').textContent=fmt(total);
  const now=new Date();
  document.getElementById('monthLabel').textContent=`За ${now.toLocaleString('ru-RU',{month:'long',year:'numeric'})}`;
}

function saveEntry(){
  let pid=document.getElementById('productSelect').value;
  let qty=parseInt(document.getElementById('qtyInput').value)||0;
  if(!pid||qty<=0) return;
  let p=products.find(x=>x.id==pid);
  let total=p.price*qty;
  let e={id:crypto.randomUUID(),date:todayISO(),productId:p.id,name:p.name,price:p.price,qty:qty,total:total,synced:false};
  entries.push(e); save(KEYS.entries,entries);
  renderEntries();
  document.getElementById('qtyInput').value='';
  document.getElementById('lastStatus').textContent='Сохранено локально';
  addProductionToAirtable(e);
}

function delEntry(id){
  entries=entries.filter(x=>x.id!=id);
  save(KEYS.entries,entries);
  renderEntries();
}

function toggleSettings(){
  const c=document.getElementById('settingsCard');
  c.classList.toggle('hidden');
  document.getElementById('airtableKey').value=settings.airtableKey||'';
  document.getElementById('airtableBase').value=settings.airtableBase||'';
  document.getElementById('productsTable').value=settings.productsTable||'Products';
  document.getElementById('productionTable').value=settings.productionTable||'Production';
  renderProductsListInSettings();
}

document.getElementById('airtableKey').addEventListener('change',e=>{settings.airtableKey=e.target.value; save(KEYS.settings,settings);});
document.getElementById('airtableBase').addEventListener('change',e=>{settings.airtableBase=e.target.value; save(KEYS.settings,settings);});
document.getElementById('productsTable').addEventListener('change',e=>{settings.productsTable=e.target.value; save(KEYS.settings,settings);});
document.getElementById('productionTable').addEventListener('change',e=>{settings.productionTable=e.target.value; save(KEYS.settings,settings);});

function syncAirtable(){
  entries.filter(e=>!e.synced).forEach(addProductionToAirtable);
}

async function testAirtableConnection(){
  const statusEl=document.getElementById('testStatus');
  if(!settings.airtableKey||!settings.airtableBase){statusEl.textContent='Введите API Token и Base ID'; statusEl.style.color='red'; return;}
  statusEl.textContent='Проверка...'; statusEl.style.color='black';
  try{
    const res=await fetch(airtableURL(settings.productsTable||'Products'), {headers: airtableHeaders()});
    if(res.ok){statusEl.textContent='Подключение успешно'; statusEl.style.color='green'; fetchProductsFromAirtable();}
    else{statusEl.textContent='Ошибка подключения'; statusEl.style.color='red';}
  }catch(e){statusEl.textContent='Ошибка: '+e.message; statusEl.style.color='red';}
}

async function addProductToAirtable(){
  const name=document.getElementById('prodName').value.trim();
  const price=parseFloat(document.getElementById('prodPrice').value)||0;
  if(!name){alert('Введите название продукта');return;}
  if(!settings.airtableKey||!settings.airtableBase){alert('Сначала укажите настройки AirTable');return;}
  try {
    const body={fields:{"Name":name,"Price":price}};
    const res=await fetch(airtableURL(settings.productsTable||'Products'), {
      method:'POST', headers: airtableHeaders(), body: JSON.stringify(body)
    });
    if(!res.ok) throw new Error(await res.text());
    const data=await res.json();
    products.push({id:data.id, name, price});
    save(KEYS.products, products);
    renderProducts();
    renderProductsListInSettings();
    document.getElementById('prodName').value='';
    document.getElementById('prodPrice').value='';
  } catch(e){alert(`Ошибка при добавлении продукта: ${e.message}`);}
}

fetchProductsFromAirtable();
renderProducts();
renderEntries();
</script>
</body>
</html>
