<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Учет сделки</title>
<style>
/* ... стили как раньше ... */
</style>
</head>
<body>
<header>
  <h1>Учет сделки</h1>
  <button onclick="toggleSettings()">Настройки</button>
</header>
<main>
  <!-- KPI -->
  <section class="card">
    <div class="muted" id="monthLabel"></div>
    <strong id="monthTotal">0 ₽</strong>
  </section>

  <!-- Новая запись -->
  <section class="card">
    <h3>Новая запись</h3>
    <div class="row">
      <div style="flex:1"><label>Тип продукции</label><select id="productSelect"></select></div>
      <div style="flex:1"><label>Количество</label><input id="qtyInput" type="number" min="0"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="primary" onclick="saveEntry()">Сохранить</button>
      <button class="secondary" onclick="syncAll()">Синхронизировать всё</button>
    </div>
    <div class="muted" id="lastStatus"></div>
  </section>

  <!-- Таблица записей -->
  <section class="card">
    <h3>Записи этого месяца</h3>
    <table class="list">
      <thead><tr><th>Дата</th><th>Продукт</th><th class="right">Кол-во</th><th class="right">Цена</th><th class="right">Сумма</th><th></th></tr></thead>
      <tbody id="entriesBody"></tbody>
      <tfoot><tr><th colspan="4" class="right">ИТОГО</th><th class="right" id="tableTotal">0 ₽</th><th></th></tr></tfoot>
    </table>
  </section>

  <!-- Настройки -->
  <section id="settingsCard" class="card hidden">
    <h3>Настройки</h3>
    <label>Apps Script URL</label>
    <input id="appsScriptUrl">
    <label>ID Google Таблицы</label>
    <input id="sheetId">
    <label>Лист Production</label><input id="productionSheet" value="Production">
    <label>Лист Products</label><input id="productsSheet" value="Products">
    <h4 style="margin-top:20px;">Типы продукции</h4>
    <div class="row">
      <input id="prodName" placeholder="Название">
      <input id="prodPrice" type="number" placeholder="Цена ₽">
      <button class="primary" onclick="addProduct()">Добавить</button>
    </div>
    <table class="list" style="margin-top:10px;">
      <thead><tr><th>Название</th><th class="right">Цена</th><th></th></tr></thead>
      <tbody id="productsBody"></tbody>
    </table>
  </section>
</main>

<script>
const KEYS={products:'gs_products',entries:'gs_entries',settings:'gs_settings'};
let products=JSON.parse(localStorage.getItem(KEYS.products)||'[]');
let entries=JSON.parse(localStorage.getItem(KEYS.entries)||'[]');
let settings=JSON.parse(localStorage.getItem(KEYS.settings)||'{}');
const fmt=n=>new Intl.NumberFormat('ru-RU',{style:'currency',currency:'RUB',maximumFractionDigits:0}).format(n);
const todayISO=()=>new Date().toISOString().split('T')[0];
function save(k,v){localStorage.setItem(k,JSON.stringify(v));}
function isThisMonth(date){const d=new Date(date), n=new Date();return d.getMonth()==n.getMonth()&&d.getFullYear()==n.getFullYear();}

function renderProducts(){
  const sel=document.getElementById('productSelect'); sel.innerHTML='';
  products.forEach(p=>{
    let opt=document.createElement('option');
    opt.value=p.id; opt.textContent=`${p.name} — ${fmt(p.price)}`;
    sel.appendChild(opt);
  });
  const tb=document.getElementById('productsBody'); tb.innerHTML='';
  products.forEach(p=>{
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.name}</td><td class="right">${fmt(p.price)}</td>
                  <td class="right"><button class="danger" onclick="delProduct('${p.id}')">×</button></td>`;
    tb.appendChild(tr);
  });
}

function renderEntries(){
  let body=document.getElementById('entriesBody'); body.innerHTML=''; let total=0;
  entries.filter(e=>isThisMonth(e.date)).forEach(e=>{
    total+=e.total;
    let tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.date}</td><td>${e.name}</td><td class="right">${e.qty}</td>
                  <td class="right">${fmt(e.price)}</td><td class="right">${fmt(e.total)}</td>
                  <td><span class="danger" onclick="delEntry('${e.id}')">×</span></td>`;
    body.appendChild(tr);
  });
  document.getElementById('tableTotal').textContent=fmt(total);
  document.getElementById('monthTotal').textContent=fmt(total);
  document.getElementById('monthLabel').textContent=`${new Date().toLocaleString('ru-RU',{month:'long',year:'numeric'})}`;
}

function addProduct(){
  let name=document.getElementById('prodName').value.trim();
  let price=parseFloat(document.getElementById('prodPrice').value)||0;
  if(!name) return;
  products.push({id:crypto.randomUUID(), name, price, synced:false});
  save(KEYS.products,products);
  renderProducts();
  document.getElementById('prodName').value='';
  document.getElementById('prodPrice').value='';
}

function delProduct(id){
  if (confirm('Удалить этот продукт?')){
    products=products.filter(p=>p.id!==id);
    save(KEYS.products,products);
    renderProducts();
  }
}

function saveEntry(){
  let pid=document.getElementById('productSelect').value;
  let qty=parseFloat(document.getElementById('qtyInput').value)||0;
  if(!pid||qty<=0) return;
  let prod=products.find(p=>p.id==pid);
  let total=prod.price*qty;
  let entry={id:crypto.randomUUID(), date:todayISO(), productId:pid, name:prod.name, price:prod.price, qty, total, synced:false};
  entries.push(entry); save(KEYS.entries,entries);
  renderEntries();
  document.getElementById('qtyInput').value='';
}

function delEntry(id){
  let entry=entries.find(e=>e.id===id);
  if(!entry) return;
  if(confirm('Удалить эту запись?')){
    if(entry.sheetRow && settings.appsScriptUrl && settings.sheetId){
      fetch(settings.appsScriptUrl, {
        method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},
        body:JSON.stringify({
          type:'deleteProduction',
          spreadsheetId:settings.sheetId,
          sheetName:settings.productionSheet||'Production',
          rowIndex: entry.sheetRow
        })
      });
    }
    entries=entries.filter(e=>e.id!==id);
    save(KEYS.entries,entries);
    renderEntries();
  }
}

function syncProducts(){
  const unsynced=products.filter(p=>!p.synced);
  if(!unsynced.length) return;
  fetch(settings.appsScriptUrl,{
    method:'POST',headers:{'Content-Type':'text/plain;charset=UTF-8'},
    body:JSON.stringify({
      type:'appendProducts',
      spreadsheetId:settings.sheetId,
      sheetName:settings.productsSheet||'Products',
      products: unsynced.map(p=>[p.id,p.name,p.price])
    })
  }).then(r=>r.json()).then(data=>{
    if(data.success){
      unsynced.forEach(p=>p.synced=true);
      save(KEYS.products,products);
      renderProducts();
    }
  });
}

function syncSheets(){
  const unsent=entries.filter(e=>!e.synced);
  if(!unsent.length){return;}
  fetch(settings.appsScriptUrl,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=UTF-8'},
    body:JSON.stringify({
      type:'appendProduction',
      spreadsheetId:settings.sheetId,
      sheetName:settings.productionSheet||'Production',
      rows:unsent.map(e=>[new Date().toISOString(),e.date,e.productId,e.name,e.price,e.qty,e.total])
    })
  }).then(r=>r.json()).then(data=>{
    if(data.success){
      unsent.forEach((e,i)=>{e.synced=true; e.sheetRow=data.inserted[i];});
      save(KEYS.entries,entries);
      renderEntries();
    }
  });
}

function syncAll(){
  if(!settings.appsScriptUrl||!settings.sheetId){alert('Укажите настройки Google Script');return;}
  syncProducts();
  syncSheets();
}

function toggleSettings(){
  document.getElementById('settingsCard').classList.toggle('hidden');
  document.getElementById('appsScriptUrl').value=settings.appsScriptUrl||'';
  document.getElementById('sheetId').value=settings.sheetId||'';
  document.getElementById('productionSheet').value=settings.productionSheet||'Production';
  document.getElementById('productsSheet').value=settings.productsSheet||'Products';
}

['appsScriptUrl','sheetId','productionSheet','productsSheet'].forEach(id=>{
  document.getElementById(id).addEventListener('input',e=>{
    settings[e.target.id]=e.target
